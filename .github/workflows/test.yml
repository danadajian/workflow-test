name: Check Merge Safety

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    name: Merge Safety
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - uses: nrwl/nx-set-shas@v3

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          run_install: true
          version: 7.9.0

      - name: Get Changed Projects
        id: changed-projects
        run: echo "::set-output name=CHANGED_PROJECTS::$(nx print-affected | jq '.projects[]')"

      - run: echo "${{ steps.changed-projects.outputs.CHANGED_PROJECTS }}"

      - uses: ExpediaGroup/github-helpers@simplify-check-merge-safety
        with:
          helper: check-merge-safety
          paths: ${{ steps.changed-projects.outputs.CHANGED_PROJECTS }}
          override_filter_paths: |
            package.json
            pnpm-lock.yaml
          github_token: ${{ secrets.GITHUB_TOKEN }}
